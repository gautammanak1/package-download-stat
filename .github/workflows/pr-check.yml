name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-pr:
    name: PR Validation
    runs-on: ubuntu-latest
    # Skip commit message validation for Dependabot PRs
    if: github.actor != 'dependabot[bot]'
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check PR title format
        if: github.actor != 'dependabot[bot]'
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          # Convert to lowercase and replace slashes with colons for matching
          TITLE_LOWER=$(echo "$PR_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/\//:/g')

          # Check if title starts with valid type (case-insensitive, handles Fix/ or fix:)
          if echo "$TITLE_LOWER" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?:"; then
            echo "✅ PR title format is valid: $PR_TITLE"
            exit 0
          else
            echo "❌ Invalid PR title format: $PR_TITLE"
            echo "PR title must start with one of: feat, fix, docs, style, refactor, perf, test, chore"
            echo "Examples:"
            echo "  - fix: Allow merge commit messages"
            echo "  - Fix: Allow merge commit messages"
            echo "  - feat: Add new feature"
            echo "  - docs: Update README"
            exit 1
          fi

      - name: Validate commit messages
        if: github.actor != 'dependabot[bot]'
        run: |
          git log --oneline origin/main..HEAD | while read line; do
            # Skip merge commits (they contain "Merge" or "into")
            if echo "$line" | grep -qE "Merge|into [a-f0-9]+"; then
              echo "ℹ️ Skipping merge commit: $line"
              continue
            fi
            # Extract commit message (everything after the hash and space)
            COMMIT_MSG=$(echo "$line" | sed 's/^[a-f0-9]* //')
            # Validate commit message follows Conventional Commits format
            if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?:"; then
              echo "❌ Invalid commit message: $COMMIT_MSG"
              echo "Commit messages must follow Conventional Commits format"
              echo "Example: fix: Description of the fix"
              exit 1
            else
              echo "✅ Valid commit: $COMMIT_MSG"
            fi
          done

      - name: Check file size
        run: |
          MAX_SIZE=1048576  # 1MB
          for file in $(git diff --name-only origin/main...HEAD); do
            size=$(git cat-file -s "HEAD:$file" 2>/dev/null || echo 0)
            if [ "$size" -gt "$MAX_SIZE" ]; then
              echo "❌ File $file exceeds maximum size of 1MB"
              exit 1
            fi
          done

      - name: Check for large files
        run: |
          if git diff --name-only origin/main...HEAD | grep -E '\.(png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$' | xargs -I {} sh -c 'test $(git cat-file -s "HEAD:{}" 2>/dev/null || echo 0) -gt 500000'; then
            echo "⚠️ Warning: Large image/font files detected. Consider optimizing them."
          fi
